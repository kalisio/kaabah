(window.webpackJsonp=window.webpackJsonp||[]).push([[11],{179:function(t,e,r){"use strict";r.r(e);var s=r(0),a=Object(s.a)({},function(){var t=this,e=t.$createElement,r=t._self._c||e;return r("div",{staticClass:"content"},[t._m(0),t._v(" "),r("div",{staticClass:"warning custom-block"},[r("p",{staticClass:"custom-block-title"},[t._v("WARNING")]),t._v(" "),r("p",[r("strong",[t._v("Kaabah")]),t._v(" relies on various technologies such as "),r("a",{attrs:{href:"https://www.terraform.io/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Terraform"),r("OutboundLink")],1),t._v(", "),r("a",{attrs:{href:"https://docs.docker.com/engine/swarm/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Docker Swarm"),r("OutboundLink")],1),t._v(", "),r("a",{attrs:{href:"https://portainer.io",target:"_blank",rel:"noopener noreferrer"}},[t._v("Traefik"),r("OutboundLink")],1),t._v("... and we assume that you are enough familiar with them. If not, please take a while to discover them.")])]),t._v(" "),t._m(1),t._v(" "),t._m(2),t._v(" "),t._m(3),t._v(" "),t._m(4),t._v(" "),t._m(5),t._v(" "),r("p",[t._v("In addition, "),r("strong",[t._v("Kaabah")]),t._v(" makes the assumption you already have a "),r("a",{attrs:{href:"https://en.wikipedia.org/wiki/Bastion_host",target:"_blank",rel:"noopener noreferrer"}},[r("strong",[t._v("Bastion")]),r("OutboundLink")],1),t._v(" installed for each providers. You must provide the information to access the bastions:")]),t._v(" "),t._m(6),t._v(" "),t._m(7),t._v(" "),t._m(8),t._v(" "),t._m(9),t._v(" "),r("p",[t._v("You can use the following "),r("a",{attrs:{href:"https://gist.github.com/cnouguier/c5cb4ba99ad45bced4476e2d175342a1",target:"_blank",rel:"noopener noreferrer"}},[t._v("script"),r("OutboundLink")],1),t._v(" to create these files.")]),t._v(" "),t._m(10),t._v(" "),r("p",[t._v("You must have the credentials set to access the desired bucket on AWS S3 otherwise "),r("strong",[t._v("Terraform")]),t._v(" won't initialize.\nIf needed, follow this "),r("a",{attrs:{href:"https://docs.aws.amazon.com/sdk-for-java/v1/developer-guide/setup-credentials.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("guide"),r("OutboundLink")],1),t._v(" to set up your credentials.")]),t._v(" "),t._m(11),t._v(" "),t._m(12),t._v(" "),t._m(13),t._m(14),t._v(" "),t._m(15),t._v(" "),t._m(16),t._v(" "),t._m(17),t._m(18),t._v(" "),t._m(19),t._m(20),t._v(" "),t._m(21),r("ol",{attrs:{start:"5"}},[r("li",[t._v("Define the "),r("a",{attrs:{href:"https://www.terraform.io/docs/backends/types/s3.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("S3 backend"),r("OutboundLink")],1),t._v(" properties")])]),t._v(" "),t._m(22),t._v(" "),t._m(23),t._m(24),t._v(" "),t._m(25),t._m(26),t._v(" "),r("div",{staticClass:"warning custom-block"},[r("p",{staticClass:"custom-block-title"},[t._v("ACME certificates")]),t._v(" "),r("p",[t._v("To ensure ACME certificates generation, "),r("strong",[t._v("traefik")]),t._v(" has to be reachable by "),r("strong",[t._v("Let's Encrypt")]),t._v(" through port 80. You can refer to "),r("a",{attrs:{href:"https://docs.traefik.io/configuration/acme/#httpchallenge",target:"_blank",rel:"noopener noreferrer"}},[t._v("ACME configuration (httpChallenge)"),r("OutboundLink")],1),t._v(" for further information.")]),t._v(" "),t._m(27)]),t._v(" "),t._m(28),t._v(" "),t._m(29),t._m(30),t._v(" "),t._m(31),t._v(" "),t._m(32),t._v(" "),t._m(33),t._m(34),t._v(" "),r("p",[t._v("Within your workspace, apply Terraform with your specific configuration:")]),t._v(" "),t._m(35),r("p",[t._v("After a while, your cluster should be created and the corresponding Terraform states stored in your S3 backend.")]),t._v(" "),t._m(36),t._v(" "),t._m(37),t._v(" "),t._m(38),t._m(39),t._m(40),t._v(" "),r("p",[t._v("To destroy the created infrastructure, you can simply type the following command:")]),t._v(" "),t._m(41)])},[function(){var t=this.$createElement,e=this._self._c||t;return e("h1",{attrs:{id:"getting-started"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#getting-started","aria-hidden":"true"}},[this._v("#")]),this._v(" Getting started")])},function(){var t=this.$createElement,e=this._self._c||t;return e("h2",{attrs:{id:"prerequisites"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#prerequisites","aria-hidden":"true"}},[this._v("#")]),this._v(" Prerequisites")])},function(){var t=this.$createElement,e=this._self._c||t;return e("h3",{attrs:{id:"providers-authentication"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#providers-authentication","aria-hidden":"true"}},[this._v("#")]),this._v(" Providers authentication")])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[this._v("To enable "),e("strong",[this._v("Terraform")]),this._v(" to exploit the providers APIs, you must have created an account and be aware of your credentials to access the APIs.")])},function(){var t=this.$createElement,e=this._self._c||t;return e("h3",{attrs:{id:"instances-authentication"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#instances-authentication","aria-hidden":"true"}},[this._v("#")]),this._v(" Instances authentication")])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[this._v("When running "),e("strong",[this._v("Kaabah")]),this._v(" and to get connected to your instances, you must be aware of the private SSH keys to access the instances. These keys are generally created\nusing the providers functionalities.")])},function(){var t=this.$createElement,e=this._self._c||t;return e("ul",[e("li",[this._v("the public IP")]),this._v(" "),e("li",[this._v("the SSH private key")]),this._v(" "),e("li",[this._v("the SSH user")])])},function(){var t=this.$createElement,e=this._self._c||t;return e("h3",{attrs:{id:"docker-tls-certificate-authority"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#docker-tls-certificate-authority","aria-hidden":"true"}},[this._v("#")]),this._v(" Docker TLS Certificate Authority")])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[e("strong",[this._v("Kaabah")]),this._v(" ensures TLS authentication for Docker daemon and requires a Certificate Authority (CA). The following files are required to run "),e("strong",[this._v("Kaabah")]),this._v(":")])},function(){var t=this,e=t.$createElement,r=t._self._c||e;return r("ul",[r("li",[t._v("the CA private key: "),r("code",[t._v("ca.key")])]),t._v(" "),r("li",[t._v("the CA public key: "),r("code",[t._v("ca.cert")])]),t._v(" "),r("li",[t._v("the CA passphrase file: "),r("code",[t._v("ca.pass")])])])},function(){var t=this.$createElement,e=this._self._c||t;return e("h3",{attrs:{id:"terraform-backend"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#terraform-backend","aria-hidden":"true"}},[this._v("#")]),this._v(" Terraform backend")])},function(){var t=this.$createElement,e=this._self._c||t;return e("h2",{attrs:{id:"installation"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#installation","aria-hidden":"true"}},[this._v("#")]),this._v(" Installation")])},function(){var t=this.$createElement,e=this._self._c||t;return e("h3",{attrs:{id:"clone-the-github-repository"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#clone-the-github-repository","aria-hidden":"true"}},[this._v("#")]),this._v(" Clone the Github repository")])},function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[this._v("$ "),e("span",{pre:!0,attrs:{class:"token function"}},[this._v("git")]),this._v(" clone https://github.com/kalisio/kaabah.git\n$ "),e("span",{pre:!0,attrs:{class:"token function"}},[this._v("cd")]),this._v(" kaabah\n")])])])},function(){var t=this.$createElement,e=this._self._c||t;return e("h3",{attrs:{id:"setup-your-terraform-environment"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#setup-your-terraform-environment","aria-hidden":"true"}},[this._v("#")]),this._v(" Setup your Terraform environment")])},function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"warning custom-block"},[e("p",{staticClass:"custom-block-title"},[this._v("Security")]),this._v(" "),e("p",[this._v("Hard-coding credentials into any "),e("strong",[this._v("Terraform")]),this._v(" configuration is not recommended, and risks secret leakage should this file ever be committed to a public version control system.\nWe strongly recommend to store the credentials using environment variables.")])])},function(){var t=this.$createElement,e=this._self._c||t;return e("ol",[e("li",[this._v("Define your "),e("strong",[this._v("Scaleway")]),this._v(" credentials")])])},function(){var t=this,e=t.$createElement,r=t._self._c||e;return r("div",{staticClass:"language-bash extra-class"},[r("pre",{pre:!0,attrs:{class:"language-bash"}},[r("code",[r("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$export")]),t._v(" TF_VAR_SCALEWAY_ORGANIZATION"),r("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),r("span",{pre:!0,attrs:{class:"token string"}},[t._v('"<ORGANIZATION-ID>"')]),t._v("\n"),r("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$export")]),t._v(" TF_VAR_SCALEWAY_TOKEN"),r("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),r("span",{pre:!0,attrs:{class:"token string"}},[t._v('"<ACCESS-TOKEN>"')]),t._v(" \n")])])])},function(){var t=this.$createElement,e=this._self._c||t;return e("ol",{attrs:{start:"2"}},[e("li",[this._v("Define your "),e("strong",[this._v("AWS")]),this._v(" credentials")])])},function(){var t=this,e=t.$createElement,r=t._self._c||e;return r("div",{staticClass:"language-bash extra-class"},[r("pre",{pre:!0,attrs:{class:"language-bash"}},[r("code",[r("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$export")]),t._v(" TF_VAR_AWS_ACCESS_KEY"),r("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),r("span",{pre:!0,attrs:{class:"token string"}},[t._v('"<ACCESS-KEY>"')]),t._v("\n"),r("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$export")]),t._v(" TF_VAR_AWS_SECRET_KEY"),r("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),r("span",{pre:!0,attrs:{class:"token string"}},[t._v('"<SECRET-KEY>"')]),t._v(" \n")])])])},function(){var t=this.$createElement,e=this._self._c||t;return e("ol",{attrs:{start:"3"}},[e("li",[e("p",[this._v("Define your "),e("strong",[this._v("OVH")]),this._v(" credentials")])]),this._v(" "),e("li",[e("p",[this._v("Define your bastions configuration")])])])},function(){var t=this,e=t.$createElement,r=t._self._c||e;return r("div",{staticClass:"language-bash extra-class"},[r("pre",{pre:!0,attrs:{class:"language-bash"}},[r("code",[r("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$TF_VAR_bastion_ips")]),t._v(" "),r("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),r("span",{pre:!0,attrs:{class:"token string"}},[t._v('\'{ AWS = "X.X.X.X", SCW = "Y.Y.Y.Y", OVH = "Z.Z.Z.Z" }\'')]),t._v("\n"),r("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$TF_VAR_bastion_ssh_keys")]),t._v(" "),r("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),r("span",{pre:!0,attrs:{class:"token string"}},[t._v('\'{ AWS = "aws.pem", SCW = "scw.pem", OVH = "ovh.pem" }\'')]),t._v("\n"),r("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$TF_VAR_bastion_ssh_users")]),t._v(" "),r("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),r("span",{pre:!0,attrs:{class:"token string"}},[t._v('\'{ AWS = "user", SCW = "user", OVH = "user" }\'')]),t._v("\n")])])])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[this._v("Create a file "),e("code",[this._v("backend.config")]),this._v(" with the following properties:")])},function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[this._v('bucket = "the name of the bucket"\nregion = "the region of the bucket"\nkey    = "the key to the states"\n')])])])},function(){var t=this.$createElement,e=this._self._c||t;return e("ol",{attrs:{start:"6"}},[e("li",[this._v("Initialize Terraform")])])},function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token variable"}},[this._v("$terraform")]),this._v(" init -backend-config"),e("span",{pre:!0,attrs:{class:"token operator"}},[this._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[this._v('"path/to/your/backend.config"')]),this._v("\n")])])])},function(){var t=this.$createElement,e=this._self._c||t;return e("h2",{attrs:{id:"usage"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#usage","aria-hidden":"true"}},[this._v("#")]),this._v(" Usage")])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[this._v("Please take care your DNS is correctly configured. A "),e("strong",[this._v("A Record")]),this._v(" should map your domain to the Swarm manager IP address.")])},function(){var t=this.$createElement,e=this._self._c||t;return e("h3",{attrs:{id:"create-a-workspace"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#create-a-workspace","aria-hidden":"true"}},[this._v("#")]),this._v(" Create a workspace")])},function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token variable"}},[this._v("$terraform")]),this._v(" workspace new demo\n")])])])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[this._v("Terraform will automatically switch to the created workspace "),e("code",[this._v("demo")])])},function(){var t=this.$createElement,e=this._self._c||t;return e("h3",{attrs:{id:"configure-the-workspace"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#configure-the-workspace","aria-hidden":"true"}},[this._v("#")]),this._v(" Configure the workspace")])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[this._v("We recommend to create a "),e("code",[this._v("tfvars")]),this._v(" file to override the default variables for your workspace. For instance, the "),e("code",[this._v("demo.tfvars")]),this._v(" file may look like this:")])},function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"language-text extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[this._v('provider = "AWS"\n\nssh_key = "workspaces/key.pem" # the path to the private key\n\nmanager_ip = "3.120.200.41"\n\nmanager_instance_type = "t2.small"\n\nmanager_user_script = "workspaces/test-script.sh"\n\nworker_instance_type = "t3.large"\n\nworker_instance_count = 3\n\nworker_additional_volume_count = 1\n\nworker_additional_volume_size = 1000\n\nworker_additional_volume_type = "io1"\n\nworker_labels=["worker0=true apps=true", "worker1=true", "worker2=true dbs=true"]\n\nworker_user_scripts=["workspaces/test-script.sh", "workspaces/test-script.sh", "workspaces/test-script.sh"]\n\nca_server = "https://acme-staging-v02.api.letsencrypt.org/directory"\n')])])])},function(){var t=this.$createElement,e=this._self._c||t;return e("h3",{attrs:{id:"apply-the-changes"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#apply-the-changes","aria-hidden":"true"}},[this._v("#")]),this._v(" Apply the changes")])},function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token variable"}},[this._v("$terraform")]),this._v(" apply -var-file"),e("span",{pre:!0,attrs:{class:"token operator"}},[this._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[this._v('"path/to/your/config.tfvars"')]),this._v("\n")])])])},function(){var t=this.$createElement,e=this._self._c||t;return e("h3",{attrs:{id:"check-the-infrastructure"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#check-the-infrastructure","aria-hidden":"true"}},[this._v("#")]),this._v(" Check the infrastructure")])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[this._v("Get connected to the manager of your infrastructure using "),e("code",[this._v("ssh")]),this._v(" and type the following commands:")])},function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token variable"}},[this._v("$docker")]),this._v(" node "),e("span",{pre:!0,attrs:{class:"token function"}},[this._v("ls")]),this._v("\nID                            HOSTNAME            STATUS              AVAILABILITY        MANAGER STATUS      ENGINE VERSION\nrwwms640br7eworemnzm71kas *   app-dev-manager    Ready               Active              Leader              18.03.1-ce\ncncd3bj11drznaih0zgsxoi2y     app-dev-worker-1   Ready               Active                                  18.03.1-ce\n4fup9ac9pklv5h81v0o99w40h     app-dev-worker-2   Ready               Active                                  18.03.1-ce\n")])])])},function(){var t=this,e=t.$createElement,r=t._self._c||e;return r("div",{staticClass:"language-bash extra-class"},[r("pre",{pre:!0,attrs:{class:"language-bash"}},[r("code",[r("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$docker")]),t._v(" "),r("span",{pre:!0,attrs:{class:"token function"}},[t._v("service")]),t._v(" "),r("span",{pre:!0,attrs:{class:"token function"}},[t._v("ls")]),t._v("\nID                  NAME                         MODE                REPLICAS            IMAGE                           PORTS\njwyzwgo2mjyb        services_alertmanager        replicated          1/1                 prom/alertmanager:latest\na35bnom5voa1        services_blackbox-exporter   replicated          1/1                 prom/blackbox-exporter:latest\nsr7c26casj5o        services_cadvisor            global              3/3                 google/cadvisor:latest          *:8081-"),r("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("8080/tcp\nyp94tsujdftq        services_grafana             replicated          1/1                 grafana/grafana:latest\njql9o8nawlkm        services_node-exporter       global              3/3                 prom/node-exporter:latest\n0jl7slbb6tll        services_portainer           replicated          1/1                 portainer/portainer:latest\nhgeulxbwkex2        services_prometheus          replicated          1/1                 prom/prometheus:latest\nltstocwymexj        services_traefik             replicated          1/1                 traefik:latest\n")])])])},function(){var t=this.$createElement,e=this._self._c||t;return e("h3",{attrs:{id:"destroy-the-infrastructure"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#destroy-the-infrastructure","aria-hidden":"true"}},[this._v("#")]),this._v(" Destroy the infrastructure")])},function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token variable"}},[this._v("$terraform")]),this._v(" apply -var-file"),e("span",{pre:!0,attrs:{class:"token operator"}},[this._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[this._v('"path/to/your/config.tfvars"')]),this._v("\n")])])])}],!1,null,null,null);e.default=a.exports}}]);